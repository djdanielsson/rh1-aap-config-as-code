---
# Pre-commit hooks for aap-config-as-code repository
# AAP Configuration as Code - Ansible playbooks and group_vars
#
# Installation:
#   pip install pre-commit
#   pre-commit install
#
# Run manually:
#   pre-commit run --all-files

repos:
  # ============================================================================
  # General Checks - All Files
  # ============================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      # Prevent large files from being committed
      - id: check-added-large-files
        args: ['--maxkb=500']
        
      # Ensure files end with newline
      - id: end-of-file-fixer
        
      # Remove trailing whitespace
      - id: trailing-whitespace
        args: ['--markdown-linebreak-ext=md']
        
      # Verify YAML syntax
      - id: check-yaml
        
      # Check for merge conflict markers
      - id: check-merge-conflict
        
      # Prevent committing to main/master directly
      - id: no-commit-to-branch
        args: ['--branch', 'main', '--branch', 'master']
        
      # Check case conflicts
      - id: check-case-conflict
        
      # Ensure scripts have proper shebang
      - id: check-executables-have-shebangs

  # ============================================================================
  # Ansible Linting
  # ============================================================================
  - repo: https://github.com/ansible/ansible-lint
    rev: v6.22.1
    hooks:
      - id: ansible-lint
        args:
          - '--config-file=.ansible-lint'
          - '--force-color'
          - '--profile=production'
        files: \.(yaml|yml)$

  # ============================================================================
  # YAML Linting
  # ============================================================================
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.33.0
    hooks:
      - id: yamllint
        args:
          - '--config-file=.yamllint'
        files: \.(yaml|yml)$

  # ============================================================================
  # Security Scanning - Secrets Detection
  # ============================================================================
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.4.0
    hooks:
      - id: detect-secrets
        args:
          - '--baseline'
          - '.secrets.baseline'
        exclude: |
          (?x)^(
            \.secrets\.baseline
          )$

  # ============================================================================
  # GitLeaks - Additional Secrets Detection
  # ============================================================================
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.18.1
    hooks:
      - id: gitleaks

  # ============================================================================
  # Markdown Linting
  # ============================================================================
  - repo: https://github.com/markdownlint/markdownlint
    rev: v0.12.0
    hooks:
      - id: markdownlint
        args: ['--rules', '~MD013,~MD033']

  # ============================================================================
  # Constitutional Compliance Checks (Custom)
  # ============================================================================
  - repo: local
    hooks:
      - id: no-secrets-in-vars
        name: No Secrets in group_vars
        entry: |
          bash -c 'echo "Checking for secrets in group_vars..."
          for f in "$@"; do 
            if grep -iE "(password|secret|token|api[_-]?key):\s*[\"'\''][^{]" "$f" | grep -v "{{ " | grep -v "^#" | grep -v "_name:" | grep -v "secretRef" | grep -v "SecretKeyRef"; then 
              echo "❌ VIOLATION: Plain secret found in $f"
              echo "Constitution Article V: No secrets in Git"
              echo "Use {{ lookup(...) }} or reference by name"
              exit 1
            fi
          done
          echo "✅ No plain secrets detected"'
        language: system
        files: ^group_vars/.*\.(yaml|yml)$
        pass_filenames: true

  # ============================================================================
  # Variable Reference Validation
  # ============================================================================
  - repo: local
    hooks:
      - id: validate-credential-references
        name: Validate Credential References
        entry: |
          bash -c 'for f in "$@"; do 
            if grep -q "credential:" "$f"; then 
              if ! grep -E "credential:\s*\"" "$f" > /dev/null; then 
                echo "⚠️  WARNING: Credentials should be referenced by name (string)"
              fi
            fi
          done'
        language: system
        files: ^group_vars/.*/credentials\.yml$
        pass_filenames: true

  # ============================================================================
  # Naming Convention Validation
  # ============================================================================
  - repo: local
    hooks:
      - id: naming-conventions
        name: Naming Convention Check
        entry: |
          bash -c 'for f in "$@"; do if [[ "$f" == group_vars/* ]]; then if ! [[ "$f" =~ group_vars/(all|aap_dev|aap_qa|aap_prod)/ ]]; then echo "❌ VIOLATION: Invalid group_vars directory in $f"; echo "Must be: all, aap_dev, aap_qa, or aap_prod"; exit 1; fi; fi; done'
        language: system
        files: ^group_vars/
        pass_filenames: true

  # ============================================================================
  # Inventory Validation
  # ============================================================================
  - repo: local
    hooks:
      - id: inventory-check
        name: Inventory Validation
        entry: |
          bash -c 'if [ -f inventory.yml ]; then ansible-inventory -i inventory.yml --list > /dev/null || { echo "❌ Invalid inventory.yml"; exit 1; }; fi'
        language: system
        files: ^inventory\.yml$
        pass_filenames: false

  # ============================================================================
  # Playbook Syntax Check
  # ============================================================================
  - repo: local
    hooks:
      - id: playbook-syntax
        name: Ansible Playbook Syntax Check
        entry: |
          bash -c 'for f in "$@"; do if [[ "$f" == *.yml ]] && [[ "$f" != group_vars/* ]]; then echo "Checking syntax: $f"; ansible-playbook --syntax-check "$f" || exit 1; fi; done'
        language: system
        files: ^(playbook|.*-playbook)\.yml$
        pass_filenames: true

  # ============================================================================
  # Environment Separation Check
  # ============================================================================
  - repo: local
    hooks:
      - id: environment-separation
        name: Environment Separation Check
        entry: |
          bash -c 'for f in "$@"; do if [[ "$f" == group_vars/aap_prod/* ]]; then if grep -q "test\|demo\|dev" "$f"; then echo "⚠️  WARNING: Dev/test references in production config: $f"; fi; fi; done'
        language: system
        files: ^group_vars/aap_prod/
        pass_filenames: true

  # ============================================================================
  # AAP Configuration Validation
  # ============================================================================
  - repo: local
    hooks:
      - id: aap-config-structure
        name: AAP Config Structure Validation
        entry: |
          bash -c 'for f in "$@"; do basename=$(basename "$f"); if [[ "$basename" =~ ^(credentials|execution_environments|hosts|inventories|job_templates|projects|schedules|settings|workflow_templates|notifications|organizations|teams|labels|credential_types)\.yml$ ]]; then echo "✅ Valid AAP config file: $basename"; else echo "⚠️  WARNING: Unexpected filename: $basename"; fi; done'
        language: system
        files: ^group_vars/.*\.yml$
        pass_filenames: true

  # ============================================================================
  # Idempotency Check
  # ============================================================================
  - repo: local
    hooks:
      - id: idempotency-check
        name: Idempotency Check
        entry: |
          bash -c 'for f in "$@"; do if grep -E "shell:|command:|raw:" "$f" | grep -v "creates:\|removes:\|changed_when: false" | grep -v "^#"; then echo "⚠️  WARNING: Non-idempotent task detected in $f"; echo "Use creates/removes or changed_when for shell/command tasks"; fi; done'
        language: system
        files: \.(yaml|yml)$
        pass_filenames: true

  # ============================================================================
  # Documentation Check
  # ============================================================================
  - repo: local
    hooks:
      - id: readme-check
        name: README Exists Check
        entry: |
          bash -c 'if [ ! -f README.md ]; then echo "⚠️  WARNING: README.md not found"; exit 1; fi'
        language: system
        pass_filenames: false
        always_run: true



