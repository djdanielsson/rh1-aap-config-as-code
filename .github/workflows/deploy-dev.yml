---
name: Deploy to Dev (Manual)

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy" to confirm'
        required: true
      dry_run:
        description: 'Dry run mode (check only)'
        type: boolean
        default: true

jobs:
  validate-input:
    name: Validate Input
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        if: github.event.inputs.confirm != 'deploy'
        run: |
          echo "âŒ Deployment not confirmed"
          echo "Please type 'deploy' to confirm"
          exit 1

  deploy-dev:
    name: Deploy AAP Configuration to Dev
    runs-on: ubuntu-latest
    needs: validate-input
    environment: dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible and collections
        run: |
          pip install ansible-core
          ansible-galaxy collection install -r collections/requirements.yml

      - name: Run playbook (dry-run)
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "Running in DRY RUN mode (check only)"
          ansible-playbook playbook.yml \
            -i inventory.yml \
            --limit aap_dev \
            --check \
            --diff
        env:
          CONTROLLER_HOST: ${{ secrets.AAP_DEV_HOST }}
          CONTROLLER_USERNAME: ${{ secrets.AAP_DEV_USERNAME }}
          CONTROLLER_PASSWORD: ${{ secrets.AAP_DEV_PASSWORD }}
          CONTROLLER_VERIFY_SSL: "false"

      - name: Run playbook (apply)
        if: github.event.inputs.dry_run == 'false'
        run: |
          echo "Applying configuration to AAP Dev..."
          ansible-playbook playbook.yml \
            -i inventory.yml \
            --limit aap_dev \
            --diff
        env:
          CONTROLLER_HOST: ${{ secrets.AAP_DEV_HOST }}
          CONTROLLER_USERNAME: ${{ secrets.AAP_DEV_USERNAME }}
          CONTROLLER_PASSWORD: ${{ secrets.AAP_DEV_PASSWORD }}
          CONTROLLER_VERIFY_SSL: "false"

      - name: Deployment summary
        if: always()
        run: |
          echo "# Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: DEV" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

# NOTE: This is a template workflow
# In production, you would use Tekton pipelines triggered by webhooks
# This workflow is for testing/development purposes only



