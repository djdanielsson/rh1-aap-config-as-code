---
name: Pull Request Validation

on:
  pull_request:
    branches: [main, master]
    types: [opened, synchronize, reopened]

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            group_vars/**/*.yml
            group_vars/**/*.yaml

      - name: Detect environment changes
        run: |
          echo "### Changed Files by Environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -q "group_vars/aap_dev"; then
            echo "- ðŸ”µ **DEV** environment changes detected" >> $GITHUB_STEP_SUMMARY
          fi
          
          if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -q "group_vars/aap_qa"; then
            echo "- ðŸŸ¡ **QA** environment changes detected" >> $GITHUB_STEP_SUMMARY
          fi
          
          if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -q "group_vars/aap_prod"; then
            echo "- ðŸ”´ **PROD** environment changes detected" >> $GITHUB_STEP_SUMMARY
            echo "  - âš ï¸  Production changes require additional review" >> $GITHUB_STEP_SUMMARY
          fi

  check-secrets:
    name: Check for Hardcoded Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: Run detect-secrets
        run: detect-secrets scan --baseline .secrets.baseline

      - name: Check for plain passwords
        run: |
          echo "Checking for plain passwords in group_vars..."
          
          if grep -r "password:" group_vars/ | grep -v "{{ " | grep -v "#" | grep -v "_name:" | grep -v "secretRef"; then
            echo "âŒ VIOLATION: Plain password found in group_vars"
            echo "Constitution Article V: No secrets in Git"
            echo "Use {{ lookup('env', 'VAR') }} or reference by name"
            exit 1
          fi
          
          echo "âœ… No plain passwords detected"

  validate-structure:
    name: Validate AAP Config Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check group_vars structure
        run: |
          echo "Validating group_vars structure..."
          
          # Check required directories exist
          for env in all aap_dev aap_qa aap_prod; do
            if [ ! -d "group_vars/$env" ]; then
              echo "âŒ Missing required directory: group_vars/$env"
              exit 1
            fi
            echo "âœ… Found group_vars/$env"
          done

      - name: Check for valid config files
        run: |
          echo "Checking for valid AAP configuration files..."
          
          valid_files=(
            "credentials.yml"
            "execution_environments.yml"
            "hosts.yml"
            "inventories.yml"
            "job_templates.yml"
            "projects.yml"
            "schedules.yml"
            "settings.yml"
            "workflow_templates.yml"
            "notifications.yml"
            "organizations.yml"
            "teams.yml"
            "labels.yml"
            "credential_types.yml"
          )
          
          for dir in group_vars/aap_*; do
            echo "Checking $dir"
            for file in "$dir"/*.yml; do
              if [ -f "$file" ]; then
                basename=$(basename "$file")
                if [[ ! " ${valid_files[@]} " =~ " ${basename} " ]]; then
                  echo "âš ï¸  WARNING: Unexpected config file: $basename in $dir"
                fi
              fi
            done
          done

  idempotency-check:
    name: Idempotency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for non-idempotent tasks
        run: |
          echo "Checking for non-idempotent patterns..."
          
          non_idempotent_found=false
          
          if grep -r "shell:\|command:\|raw:" group_vars/ *.yml 2>/dev/null | grep -v "creates:\|removes:\|changed_when:" | grep -v "#"; then
            echo "âš ï¸  WARNING: Potentially non-idempotent task found"
            echo "Consider using creates/removes or changed_when for shell/command tasks"
            non_idempotent_found=true
          fi
          
          if [ "$non_idempotent_found" = false ]; then
            echo "âœ… No obvious non-idempotent patterns detected"
          fi

  production-safety:
    name: Production Safety Checks
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.head.ref, 'prod') || contains(github.event.pull_request.title, 'prod')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for test data in production
        run: |
          echo "Checking for test/dev references in production config..."
          
          if grep -ri "test\|demo\|example" group_vars/aap_prod/; then
            echo "âš ï¸  WARNING: Test/demo references found in production configuration"
            echo "Please review carefully"
          fi

      - name: Require production approval
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âš ï¸ **PRODUCTION CHANGE DETECTED**\n\nThis PR modifies production configuration. Additional review required.\n\n**Required Checks:**\n- [ ] Changes reviewed by platform lead\n- [ ] Changes tested in QA\n- [ ] Rollback plan documented\n- [ ] Change window scheduled'
            })

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [pr-info, check-secrets, validate-structure, idempotency-check]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# AAP Configuration Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| PR Info | ${{ needs.pr-info.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secrets Check | ${{ needs.check-secrets.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Structure Validation | ${{ needs.validate-structure.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Idempotency Check | ${{ needs.idempotency-check.result }} |" >> $GITHUB_STEP_SUMMARY



