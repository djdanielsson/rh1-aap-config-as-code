---
name: Ansible Lint

on:
  push:
    branches: ['**']
    paths:
      - '**/*.yml'
      - '**/*.yaml'
      - '.ansible-lint'
  pull_request:
    branches: [main, master]
    paths:
      - '**/*.yml'
      - '**/*.yaml'
      - '.ansible-lint'

jobs:
  ansible-lint:
    name: Ansible Lint (Production Profile)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible and ansible-lint
        run: |
          pip install ansible-core ansible-lint
          ansible-lint --version

      - name: Run ansible-lint
        run: ansible-lint --profile production --force-color

      - name: Generate lint report
        if: failure()
        run: |
          echo "# Ansible Lint Report" > lint-report.md
          echo "" >> lint-report.md
          echo "Ansible lint found issues. Please review and fix." >> lint-report.md
          echo "" >> lint-report.md
          echo '```' >> lint-report.md
          ansible-lint --profile production 2>&1 | tee -a lint-report.md || true
          echo '```' >> lint-report.md

      - name: Upload lint report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ansible-lint-report
          path: lint-report.md

  syntax-check:
    name: Ansible Syntax Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          pip install ansible-core
          ansible --version

      - name: Install collections
        run: |
          if [ -f collections/requirements.yml ]; then
            ansible-galaxy collection install -r collections/requirements.yml
          fi

      - name: Check playbook syntax
        run: |
          for playbook in *.yml; do
            if [ -f "$playbook" ] && [ "$playbook" != "inventory.yml" ]; then
              echo "Checking syntax: $playbook"
              ansible-playbook --syntax-check "$playbook"
            fi
          done

  inventory-check:
    name: Validate Inventory
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: pip install ansible-core

      - name: Validate inventory
        run: |
          if [ -f inventory.yml ]; then
            ansible-inventory -i inventory.yml --list --yaml
          fi

      - name: Check inventory groups
        run: |
          if [ -f inventory.yml ]; then
            echo "Checking for required groups..."
            for group in aap_dev aap_qa aap_prod; do
              if ! ansible-inventory -i inventory.yml --list | grep -q "$group"; then
                echo "⚠️  WARNING: Group $group not found in inventory"
              else
                echo "✅ Group $group found"
              fi
            done
          fi



